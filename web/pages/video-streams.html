<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <style>
      .layui-form-item {
        margin: 20px 50px;
      }
      .layui-table-cell .layui-form-switch {
        display: block;
        width: 45px;
      }
      .custom-switch {
        /* display: inline-flex; */
        display: block;
        align-items: center;
        cursor: pointer;
        user-select: none;
        color: #555;
        margin: auto;
      }
      .custom-switch .switch-track {
        width: 36px;
        height: 20px;
        background: #ddd;
        border-radius: 14px;
        padding: 2px;
        transition: background 0.3s ease;
        position: relative;
      }

      .custom-switch .switch-thumb {
        width: 16px;
        height: 16px;
        background: #fff;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* 开启状态 */
      .custom-switch[data-status="on"] .switch-track {
        background: #16b777;
      }

      .custom-switch[data-status="on"] .switch-thumb {
        transform: translateX(8px);
      }

      .custom-switch[data-status="off"] .switch-thumb {
        transform: translateX(-7px);
      }
    </style>
  </head>

  <body>
    <div style="padding: 16px">
      <div class="layui-card">
        <div class="layui-card-header">流ID列表</div>
        <div class="layui-card-body">
          <div style="margin-bottom: 16px">
            <button
              class="layui-btn"
              id="ID_active_pull_btn"
              style="background-color: #16baaa"
              type="button"
            >
              主动拉流
            </button>
            <button
              class="layui-btn"
              id="ID_passive_push_btn"
              style="background-color: #16baaa"
              type="button"
            >
              被动推流
            </button>
          </div>
          <table class="layui-hide" id="ID_streams_table"></table>
        </div>
      </div>
    </div>

    <!-- form 模板 -->
    <script id="ID_tpl_active_pull" type="text/html">
      <form id="ID_active_pull_form" class="layui-form" action="">
        <!-- 虚拟主机 -->
        <!-- <div class="layui-form-item">
          <label class="layui-form-label">虚拟主机</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="vhost"
              value="__defaultVhost__"
              required
              placeholder="请输入虚拟主机"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div> -->
        <input type="hidden" name="vhost" value="__defaultVhost__" />
        <!-- 应用名 -->
        <div class="layui-form-item">
          <label class="layui-form-label">应用名</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="app"
              value="live"
              required
              placeholder="请输入应用名"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- 流ID -->
        <div class="layui-form-item">
          <label class="layui-form-label">流ID</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="stream"
              required
              placeholder="请输入流ID"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- 源流地址 -->
        <div class="layui-form-item">
          <label class="layui-form-label">源流地址</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="url"
              required
              placeholder="请输入源流地址"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- 转发发流协议 -->
        <div class="layui-form-item">
          <label class="layui-form-label">转协议</label>
          <div class="layui-input-block">
            <!-- RTSP -->
            <input
              type="checkbox"
              name="enable_rtsp"
              title="RTSP / WebRTC"
              lay-skin="switch"
              checked
            />
            <!-- RTMP -->
            <input
              type="checkbox"
              name="enable_rtmp"
              title="RTMP / FLV"
              lay-skin="switch"
            />
            <!-- HLS -->
            <input
              type="checkbox"
              name="enable_hls"
              title="HLS"
              lay-skin="switch"
            />
            <!-- HLS-fMP4 -->
            <input
              type="checkbox"
              name="enable_hls_fmp4"
              title="HLS-fMP4"
              lay-skin="switch"
            />
            <!-- TS -->
            <input
              type="checkbox"
              name="enable_ts"
              title="HTTP-TS / WS-TS"
              lay-skin="switch"
            />
            <!-- fMP4 -->
            <input
              type="checkbox"
              name="enable_fmp4"
              title="HTTP-fMP4 / WS-fMP4"
              lay-skin="switch"
            />
          </div>
        </div>

        <!-- 传输协议 -->
        <div class="layui-form-item">
          <label class="layui-form-label">RTP 传输</label>
          <div class="layui-input-block">
            <select name="rtp_type">
              <option value="0">RTP over RTSP</option>
              <option value="1">RTP over UDP</option>
              <option value="2">Multicast</option>
            </select>
          </div>
        </div>

        <!-- 音频 -->
        <div class="layui-form-item">
          <label class="layui-form-label">音频处理</label>
          <div class="layui-input-block">
            <select name="audio_type">
              <option value="0">不转发音频</option>
              <option value="1">转发原音频</option>
              <option value="2">转发静音音频</option>
            </select>
          </div>
        </div>

        <!-- 提交表单按钮 -->
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button type="submit" class="layui-btn" id="btn_submit">
              提交
            </button>
            <button
              type="button"
              class="layui-btn layui-btn-primary"
              id="btn_cancel"
            >
              取消
            </button>
          </div>
        </div>
      </form>
    </script>

    <!-- toolbar 模板 -->
    <script id="ID_tpl_toolbar" type="text/html">
      <a
        class="layui-btn"
        lay-event="play"
        style="background-color: #16baaa; height: 26px;line-height: 26px;"
        >预览</a
      >
      <a
        class="layui-btn"
        lay-event="del"
        style="background-color: #ff5722; height: 26px;line-height: 26px;"
        >关闭</a
      >
    </script>

    <!-- player 模板 -->
    <script id="ID_tpl_player" type="text/html">
      <div
        style="display: flex;justify-content: center;align-items: center; margin: 16px 16px 0 16px; flex-direction: column;"
      >
        <div style=" position: relative;">
          <video
            id="ID_player"
            autoplay
            style="width:960px; height:540px; background-color: #2f363c;"
          ></video>
          <div
            id="ID_status"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; align-items: center; color: #eeeeee; font-weight: 500; font-size: 18px;"
          ></div>
        </div>
        <div id="ID_tabs" style="margin-top: 16px;"></div>
      </div>
    </script>

    <!-- record 模板 -->
    <script id="ID_tpl_record" type="text/html">
      <form id="ID_record_form" class="layui-form" action="">
        <!-- 录像 -->
        <div class="layui-form-item">
          <label class="layui-form-label">录像保留(天)</label>
          <div class="layui-input-block">
            <input
              type="number"
              name="record_days"
              value="1"
              autocomplete="off"
              class="layui-input"
              min="1"
              step="1"
              lay-affix="number"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button type="submit" class="layui-btn" id="btn_submit">
              提交
            </button>
            <button
              type="button"
              class="layui-btn layui-btn-primary"
              id="btn_cancel"
            >
              取消
            </button>
          </div>
        </div>
      </form>
    </script>

    <script>
      layui.use(["table", "layer", "form", "tabs", "jquery"], function () {
        let table = layui.table;
        let layer = layui.layer;
        let form = layui.form;
        let tabs = layui.tabs;
        let $ = layui.jquery;

        window.copyToClipboard = function (text) {
          const textarea = document.createElement("textarea");
          textarea.value = text;
          textarea.style.position = "fixed";
          textarea.style.left = "-9999px";
          textarea.style.top = "-9999px";
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand("copy");
            layer.msg("✅ 已复制", { time: 500 });
          } catch (err) {
            layer.msg("❌ 复制失败", { time: 1000 });
          }
          document.body.removeChild(textarea);
        };

        // 为不同协议设置不同颜色
        function getColorBySchema(schema) {
          const colors = {
            rtsp: "rgba(173, 216, 230, 1)",
            rtmp: "rgba(255, 165, 0, 1)",
            hls: "rgba(216, 191, 216, 1)",
            "hls.fmp4": "rgba(147, 112, 219, 1)",
            ts: "rgba(144, 238, 144, 1)",
            fmp4: "rgba(173, 255, 47, 1)",
          };
          return colors[schema] || "rgba(200, 200, 200, 1)";
        }

        function renderTable() {
          $.ajax({
            url: "/api/stream/streamid-list",
            type: "get",
            dataType: "json",
            timeout: 10000,
            success: function (res) {
              if (res.code === 0) {
                let data = res.data || [];

                table.render({
                  elem: "#ID_streams_table",
                  data: data,
                  cols: [
                    [
                      {
                        field: "id",
                        title: "序号",
                        align: "center",
                        width: 80,
                        templet: function (d) {
                          return d.LAY_NUM;
                        },
                      },
                      {
                        field: "app",
                        title: "应用名",
                        align: "center",
                        width: 120,
                        templet: function (d) {
                          return d.app;
                        },
                      },
                      {
                        field: "stream",
                        title: "流ID",
                        align: "center",
                        width: 180,
                        templet: function (d) {
                          return d.stream;
                        },
                      },
                      {
                        field: "originTypeStr",
                        title: "接入类型",
                        align: "center",
                        width: 120,
                        templet: function (d) {
                          return d.originTypeStr;
                        },
                      },
                      {
                        field: "originUrl",
                        title: "源流地址",
                        align: "center",
                        width: 300,
                      },
                      {
                        field: "peer",
                        title: "对端IP",
                        align: "center",
                        width: 180,
                        templet: function (d) {
                          data = d.originSock || {};
                          return `${data.peer_ip}:${data.peer_port}` || "";
                        },
                      },
                      {
                        field: "aliveSecond",
                        title: "时长",
                        align: "center",
                        width: 100,
                        templet: function (d) {
                          let seconds = d.aliveSecond;
                          let h = Math.floor(seconds / 3600);
                          let m = Math.floor((seconds % 3600) / 60);
                          let s = seconds % 60;
                          return (
                            (h < 10 ? "0" + h : h) +
                            ":" +
                            (m < 10 ? "0" + m : m) +
                            ":" +
                            (s < 10 ? "0" + s : s)
                          );
                        },
                      },
                      {
                        field: "isRecordingMP4",
                        title: "录制",
                        align: "center",
                        width: 100,
                        templet: function (d) {
                          let checked = d.isRecordingMP4 ? "checked" : "";
                          // return `
                          //         <input
                          //           type="checkbox"
                          //           name="recordSwitch"
                          //           lay-skin="switch"
                          //           lay-filter="recordSwitch"
                          //           data-vhost="${d.vhost}"
                          //           data-app="${d.app}"
                          //           data-stream="${d.stream}"
                          //           ${checked}
                          //         >`;
                          return `<div style="display: flex;justify-content: center;align-items: center; width: 100%; height: 100%;">
                                    <div class="custom-switch" lay-event="toggleRecord" data-vhost="${
                                      d.vhost
                                    }" data-app="${d.app}" data-stream="${
                            d.stream
                          }" data-status="${d.isRecordingMP4 ? "on" : "off"}">
                                      <div class="switch-track">
                                        <div class="switch-thumb"></div>
                                      </div>
                                    </div>
                                  </div>`;
                        },
                      },
                      {
                        field: "totalReaderCount",
                        title: "总观看人数",
                        align: "center",
                        width: 100,
                      },
                      {
                        field: "schemas",
                        title: "转协议",
                        align: "center",
                        minWidth: 150,
                        templet: function (d) {
                          // 协议映射配置（可全局定义一次）
                          const schemaConfig = [
                            { key: "rtsp", name: "RTSP" },
                            { key: "rtmp", name: "RTMP" },
                            { key: "hls", name: "HLS" },
                            { key: "hls.fmp4", name: "HLS-fMP4" },
                            { key: "ts", name: "HTTP-TS" },
                            { key: "fmp4", name: "HTTP-fMP4" },
                            { key: "webrtc", name: "WebRTC" },
                            { key: "rtc", name: "RTC" },
                          ];

                          // 提取 schemas 中的 protocol
                          let enabledSchemas = Array.isArray(d.schemas)
                            ? d.schemas.map((item) => item.schema)
                            : [];

                          // 去重
                          let uniqueSchemas = [...new Set(enabledSchemas)];

                          if (uniqueSchemas.length === 0) {
                            return '<span class="layui-badge layui-bg-gray" style="font-size:14px;border-radius:5px;">无</span>';
                          }

                          // 映射为 badge
                          return uniqueSchemas
                            .map((schema) => {
                              let config = schemaConfig.find(
                                (p) => p.key === schema
                              );
                              let displayName = config
                                ? config.name
                                : schema.toUpperCase();
                              let color = getColorBySchema(schema);
                              return `<span class="layui-badge" style="margin-right: 4px; font-size: 14px; background-color: ${color}; border-radius: 5px">${displayName}</span>`;
                            })
                            .join("");
                        },
                      },
                      {
                        field: "operate",
                        title: "操作",
                        width: 200,
                        align: "center",
                        fixed: "right",
                        toolbar: "#ID_tpl_toolbar",
                      },
                    ],
                  ],
                  page: true,
                  limits: [8, 16, 32],
                  limit: 8,
                });
              }
            },
          });
        }

        // 监听表格按钮
        table.on("tool(ID_streams_table)", function (obj) {
          let data = obj.data; // 当前行数据
          let layEvent = obj.event; // 获取 lay-event 的值（del, play）

          if (layEvent === "play") {
            let webrtc_url = `/index/api/webrtc?app=${data.app}&stream=${data.stream}&type=play`;

            // 定义外部变量
            let elem_video = null;
            let player = null;
            let statusEl = null;

            layer.open({
              type: 1,
              title: "预览",
              area: ["1000px", "100%"],
              content: $("#ID_tpl_player").html(),
              btn: [],
              success: function () {
                // 判断是否包含 rtsp 协议转发
                let hasRTSP = Array.isArray(data.schemas)
                  ? data.schemas.some((item) => item.schema === "rtsp")
                  : false;

                if (!hasRTSP) {
                  let statusEl = document.getElementById("ID_status");
                  if (statusEl) {
                    statusEl.textContent = "WebRTC 播放需转发 RTSP";
                    statusEl.style.display = "flex";
                  }
                } else {
                  elem_video = document.getElementById("ID_player");

                  player = new ZLMRTCClient.Endpoint({
                    element: elem_video,
                    debug: true,
                    zlmsdpUrl: webrtc_url,
                    recvOnly: true,
                    videoEnable: true, // 启用视频
                    audioEnable: false, // 启用音频
                    simulcast: false, // 启用多流编码
                    usedatachannel: false,
                  });

                  player.on(
                    ZLMRTCClient.Events.WEBRTC_ON_REMOTE_STREAMS,
                    (stream) => {
                      layer.msg("✅ WebRTC 播放成功", {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                    }
                  );
                  player.on(
                    ZLMRTCClient.Events.WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED,
                    (e) => {
                      layer.msg("❌ OFFER ANWSER 交换失败", {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                      player.close();
                      player = null;
                      elem_video.srcObject = null;
                      elem_video.load();
                    }
                  );
                  player.on(
                    ZLMRTCClient.Events.WEBRTC_ICE_CANDIDATE_ERROR,
                    (e) => {
                      console.log("❌ ICE 错误", e);
                    }
                  );
                  player.on(
                    ZLMRTCClient.Events.WEBRTC_ON_CONNECTION_STATE_CHANGE,
                    (state) => {
                      console.log("🔗 RTC 状态:", state);
                    }
                  );
                }

                let serverIp = window.location.hostname; // 自动获取当前域名IP
                let schemaConfig = {
                  rtsp: {
                    name: "RTSP",
                    port: 8554,
                    url: `rtsp://${serverIp}:8554/${data.app}/${data.stream}`,
                  },
                  rtmp: {
                    name: "RTMP",
                    port: 1935,
                    url: `rtmp://${serverIp}:1935/${data.app}/${data.stream}`,
                  },
                  hls: {
                    name: "HLS",
                    port: 8080,
                    url: `http://${serverIp}:8080/${data.app}/${data.stream}/hls.m3u8`,
                  },
                  "hls.fmp4": {
                    name: "HLS-fMP4",
                    port: 8080,
                    url: `http://${serverIp}:8080/${data.app}/${data.stream}/hls.fmp4.m3u8`,
                  },
                  ts: {
                    name: "HTTP-TS",
                    port: 8080,
                    url: `http://${serverIp}:8080/${data.app}/${data.stream}.live.ts`,
                  },
                  fmp4: {
                    name: "HTTP-fMP4",
                    port: 8080,
                    url: `http://${serverIp}:8080/${data.app}/${data.stream}.live.mp4`,
                  },
                };

                let headers = [];
                let bodies = [];

                (Array.isArray(data.schemas) ? data.schemas : [])
                  .filter((item) => item.schema) // 确保 schema 存在
                  .forEach((item) => {
                    let schema = item.schema;
                    let tracks = item.tracks || [];
                    let bytesSpeed = item.bytesSpeed || 0;
                    let readerCount = item.readerCount || 0;
                    let totalBytes = item.totalBytes || 0;

                    // 格式化流量单位（B, KB, MB, GB）
                    function formatBytes(bytes) {
                      if (bytes === 0) return "0 B";
                      const k = 1024;
                      const sizes = ["B", "KB", "MB", "GB"];
                      const i = Math.floor(Math.log(bytes) / Math.log(k));
                      return (
                        parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
                        " " +
                        sizes[i]
                      );
                    }

                    // 构建轨道信息 HTML
                    let trackHtml = `<div style='line-height: 1.8;'>轨道信息：<br>`;
                    if (tracks.length === 0) {
                      trackHtml += `<span>无轨道信息</span><br>`;
                    } else {
                      tracks.forEach((track) => {
                        let type =
                          track.codec_type === 0
                            ? "Video"
                            : track.codec_type === 1
                            ? "Audio"
                            : "Other";

                        let detail = "";
                        if (track.codec_type === 0) {
                          // 视频
                          detail = `编码 ${track.codec_id_name}，分辨率 ${
                            track.width
                          }x${track.height}@${track.fps || "?"}FPS，GOP ${
                            track.gop_size
                          } (${track.gop_interval_ms}ms)`;
                        } else if (track.codec_type === 1) {
                          // 音频
                          detail = `编码 ${track.codec_id_name}，${track.sample_rate}Hz，${track.channels}声道`;
                        } else {
                          detail = `编码 ${track.codec_id_name || "Unknown"}`;
                        }
                        trackHtml += `<span>【${type}】${detail}</span><br>`;
                      });
                    }
                    trackHtml += "</div>";

                    // 构建转发地址与统计信息
                    let config = schemaConfig[schema] || {
                      name: schema.toUpperCase(),
                      url: "#",
                    };
                    let protocolName = config.name;
                    let forwardUrl = config.url;

                    // 统计信息
                    let statsHtml = `
                                    <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 13px;">
                                      🌐 当前码率: ${(
                                        (bytesSpeed * 8) /
                                        1048576
                                      ).toFixed(2)} Mbps，
                                      👤 当前在线: ${readerCount} 人，
                                      📦 总流量: ${formatBytes(totalBytes)}
                                    </div>`;

                    let copyCode = `copyToClipboard('${forwardUrl}')`;

                    let html = `
                                <div style="font-size: 14px; color: #333;">

                                  ${trackHtml}
                                  ${statsHtml}

                                  <div style="margin-top: 10px;">
                                    转发地址（点击复制）：<br>
                                    <span
                                      onclick="${copyCode}"
                                      title="点击复制"
                                      style="
                                        display: inline-block;
                                        margin-top: 4px;
                                        padding: 6px 10px;
                                        background: #f0f0f0;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-family: monospace;
                                        font-size: 13px;
                                        word-break: break-all;
                                      "
                                    >
                                      ${forwardUrl}
                                    </span>
                                  </div>
                                </div>`;

                    headers.push({ title: protocolName });
                    bodies.push({ content: html });
                  });

                // 如果没有任何协议被启用
                if (bodies.length === 0) {
                  headers.push({ title: "无可用协议" });
                  bodies.push({
                    content: `<div style="color: #999; text-align: center; padding: 20px;">当前流未开启任何协议转发</div>`,
                  });
                }

                // 渲染 Tabs
                tabs.render({
                  elem: "#ID_tabs",
                  header: headers,
                  body: bodies,
                });
              },

              end: function () {
                if (player) {
                  player.close();
                  player = null;
                }
                if (elem_video) {
                  elem_video.srcObject = null;
                  elem_video.load();
                }
              },
            });
          } else if (layEvent === "del") {
            // 关闭确认
            layer.confirm(
              `确定要关闭<span style = "margin-bottom: 6px; padding: 4px; background: #f7f7f7; border-radius: 4px;">${data.app} / ${data.stream}</span>吗?`,
              {
                title: "提示",
              },
              function (index) {
                // 执行关闭请求
                $.ajax({
                  url: `/api/stream/streamid?vhost=${data.vhost}&app=${data.app}&stream=${data.stream}`,
                  type: "DELETE",
                  success: function (res) {
                    if (res.code === 0) {
                      layer.msg("✅ 关闭成功", {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                      renderTable();
                    }
                  },
                });

                layer.close(index); // 关闭弹窗
              }
            );
          } else if (layEvent === "toggleRecord") {
            let vhost = data.vhost;
            let app = data.app;
            let stream = data.stream;
            let isRecord = data.isRecordingMP4;

            if (isRecord) {
              layer.confirm(
                `确定要停止<span style = "margin-bottom: 6px; padding: 4px; background: #f7f7f7; border-radius: 4px;">${app} / ${stream}</span>录像吗?`,
                {
                  title: "提示",
                },
                function (index) {
                  $.ajax({
                    url: `/api/record/stop-record?vhost=${vhost}&app=${app}&stream=${stream}`,
                    type: "GET",
                    success: function (res) {
                      if (res.code === 0) {
                        layer.msg("✅ 关闭成功", {
                          time: 1500,
                          offset: "t",
                          shift: 1,
                        });
                        renderTable();
                      } else {
                        layer.msg("⚠️ " + res.msg, {
                          time: 1500,
                          offset: "t",
                          shift: 1,
                        });
                      }
                    },
                  });
                  layer.close(index); // 关闭弹窗
                }
              );
            } else {
              layer.open({
                type: 1,
                title: "开启录像",
                area: ["700px", "auto"],
                content: $("#ID_tpl_record").html(),
                btn: null,
                success: function (layero, index) {
                  form.render();

                  layero.find("#btn_submit").on("click", function (e) {
                    e.preventDefault(); // 阻止默认提交（防止页面刷新）

                    let $form = layero.find("#ID_record_form");

                    let formData = {};
                    $form.find("input, select").each(function () {
                      let $el = $(this);
                      let name = $el.attr("name");
                      if (!name) return true; // elem 没有 name 就跳过

                      let value;
                      if ($el.is(":checkbox")) {
                        // 处理 checkbox：checked 时取 value，否则为 'false'
                        value = $el.is(":checked") ? "true" : "false";
                      } else {
                        value = $el.val();
                      }

                      formData[name] = value;
                    });

                    if (
                      !/^\d+$/.test(formData["record_days"]) ||
                      parseInt(formData["record_days"], 10) < 0 ||
                      parseInt(formData["record_days"], 10) > 30
                    ) {
                      layer.msg("⚠️ 录像天数建议不要超过30天", {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                      return false;
                    }
                    // 发送请求
                    $.ajax({
                      url: `/api/record/start-record?vhost=${vhost}&app=${app}&stream=${stream}&record_days=${formData["record_days"]}`,
                      type: "GET",
                      success: function (res) {
                        if (res.code === 0) {
                          layer.msg("✅ 开始录像", {
                            time: 1500,
                            offset: "t",
                            shift: 1,
                          });
                          setTimeout(() => {
                            layer.close(index);
                          }, 400);
                        } else {
                          layer.msg("⚠️ " + res.msg, {
                            time: 1500,
                            offset: "t",
                            shift: 1,
                          });
                        }
                        renderTable();
                      },
                    });
                  });

                  layero.find("#btn_cancel").on("click", function () {
                    layer.close(index);
                  });
                },
                end: function () {
                  // 监听弹窗关闭就刷新表格
                  renderTable();
                },
              });
            }
          }
        });

        // 监听增加按钮
        $("#ID_active_pull_btn").on("click", function () {
          layer.open({
            type: 1,
            title: "主动拉流",
            area: ["700px", "auto"],
            content: $("#ID_tpl_active_pull").html(),
            btn: null, // 不显示底部按钮
            success: function (layero, index) {
              // 渲染 layui 表单控件（如下拉框、开关）
              form.render();

              // 绑定提交按钮事件
              layero.find("#btn_submit").on("click", function (e) {
                e.preventDefault(); // 阻止默认提交（防止页面刷新）

                // 获取表单
                let $form = layero.find("#ID_active_pull_form");

                // 必填项验证
                let isValid = true;
                $form.find("input[required]").each(function () {
                  let val = $(this).val();
                  if (!val || val.trim() === "") {
                    let placeholder = $(this).attr("placeholder") || "该字段";

                    layer.msg("⚠️ 请填写：" + placeholder, {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });

                    $(this).focus();
                    isValid = false;
                    return false; // 跳出 each 循环
                  }
                });
                if (!isValid) return false;

                // 获取所有表单数据
                let formData = {};
                $form.find("input, select").each(function () {
                  let $el = $(this);
                  let name = $el.attr("name");
                  if (!name) return true; // elem 没有 name 就跳过

                  let value;
                  if ($el.is(":checkbox")) {
                    // 处理 checkbox：checked 时取 value，否则为 'false'
                    value = $el.is(":checked") ? "true" : "false";
                  } else {
                    value = $el.val();
                  }

                  formData[name] = value;
                });

                // 打印数据（调试用）
                // console.log("提交的数据：", formData);

                // 提交
                $.ajax({
                  url: "/api/stream/active-pull",
                  type: "POST",
                  contentType: "application/json", // 明确指定
                  data: JSON.stringify(formData), // 必须 stringify
                  dataType: "json",
                  timeout: 10000,
                  success: function (res) {
                    if (res.code === 0) {
                      layer.msg("✅ 添加成功", {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                      layer.close(index);
                    } else {
                      layer.msg("⚠️ " + res.msg, {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                    }
                  },
                });
              });

              // 绑定取消按钮事件
              layero.find("#btn_cancel").on("click", function () {
                layer.close(index);
              });
            },
            end: function () {
              // 监听弹窗关闭就刷新表格
              setTimeout(() => {
                renderTable();
              }, 600);
            },
          });
        });

        renderTable();
      });
    </script>
  </body>
</html>
